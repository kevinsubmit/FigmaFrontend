# 开发更新：服务提成配置 + 技师提成统计（2026-02-11，2026-02-28更新）

## 1. 业务规则
- 每个店铺的每个服务都可单独设置提成方式：
  - 固定金额：`fixed`
  - 百分比：`percent`（按服务实际成交金额）
- 提成由店铺管理员在后台店铺服务配置中维护。
- 技师提成统计基于已完成订单（`completed`）和订单拆分（`appointment_staff_splits`）。
- 百分比提成明确按“服务实际成交金额”计算（来自订单服务项金额）。

## 2. 提成分配算法
### 2.1 固定金额（fixed）
- 非拆分单：
  - `技师提成 = 固定提成金额`
- 拆分单（同一服务拆给多个技师）：
  - `技师提成 = 固定提成金额 * (该技师该服务拆分金额 / 该服务拆分总金额)`

### 2.2 百分比（percent）
- 非拆分单：
  - `技师提成 = 服务实际成交金额 * 提成百分比`
- 拆分单：
  - `技师提成 = 该技师该服务拆分金额 * 提成百分比`

说明：
- 拆分总金额必须等于订单金额，否则不允许保存拆分。

## 3. 后端变更

### 3.1 服务提成字段
- 字段：`services.commission_amount`（`Float`, 默认 0）
- 字段：`services.commission_type`（`String(20)`, `fixed|percent`, 默认 `fixed`）
- 字段：`services.commission_value`（`Float`, 默认 0）
- 迁移：`backend/alembic/versions/20260211_003000_add_service_commission_amount.py`
- 迁移：`backend/alembic/versions/20260228_230000_add_service_commission_type_and_value.py`
- 模型与 schema：
  - `backend/app/models/service.py`
  - `backend/app/schemas/service.py`
  - `backend/app/crud/service.py`

### 3.2 技师业绩接口扩展提成
文件：`backend/app/api/v1/endpoints/technicians.py`
- `GET /api/v1/technicians/performance/summary`
  - 新增返回：`today_commission`、`total_commission`
- `GET /api/v1/technicians/{id}/performance`
  - 新增返回：`period_commission`、`total_commission`
  - 明细项新增：`commission_amount`

## 4. 管理后台变更

### 4.1 店铺服务配置支持提成类型
页面：`admin-dashboard/src/pages/StoreDetail.tsx`
- 新增服务时可选：
  - `Commission Type`: `Fixed ($)` / `Percent (%)`
  - `Commission` 数值
- 已有服务支持快速修改类型与数值。
- 百分比限制：不超过 100。

### 4.2 Staff 页面显示提成
页面：`admin-dashboard/src/pages/Staff.tsx`
- 列表新增：
  - `Today Commission`
  - `History Commission`
- 业绩明细抽屉新增：
  - 本次筛选提成
  - 历史总提成
  - 每条订单拆分明细提成

## 5. 构建验证
- 后端编译通过：`cd backend && ./venv/bin/python -m compileall app alembic`
- 管理后台构建通过：`cd admin-dashboard && npm run build`
- 规则回归脚本：`cd backend && python test_service_commission_modes.py`
