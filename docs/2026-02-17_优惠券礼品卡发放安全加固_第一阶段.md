# 2026-02-17 优惠券/礼品卡发放安全加固（第一阶段）

## 目标
围绕“资金等价物”发放场景，先落地后端强约束，防止误操作与批量滥发。

## 后端已落地

### 1. 优惠券发放风控（`/api/v1/coupons/grant` / `/grant/batch`）
文件：`backend/app/api/v1/endpoints/coupons.py`

新增校验：
1. 模板必须是激活状态（`is_active=true`）
2. 单张优惠券面值上限（默认 `$200`）
3. 批量发放人数上限（默认 `200`）
4. 当日总发放面值上限（默认 `$5000`）

说明：
- 当日总额按“已发放 + 待领取”合并计算，避免绕过限制。

### 2. 礼品卡按手机号发放安全加固（`/api/v1/gift-cards/purchase`）
文件：`backend/app/api/v1/endpoints/gift_cards.py`

新增校验：
1. 只有超管可执行“按手机号发放礼品卡”
2. 单次发放金额上限（默认 `$500`）
3. 超管当日发放总额上限（默认 `$5000`）

说明：
- 普通用户在该接口中若携带 `recipient_phone` 会被 `403` 拒绝。

### 3. 可配置阈值（环境变量）
文件：`backend/app/core/config.py`

新增配置项：
1. `ADMIN_COUPON_BATCH_MAX_RECIPIENTS`（默认 200）
2. `ADMIN_COUPON_GRANT_MAX_FACE_VALUE`（默认 200）
3. `ADMIN_COUPON_GRANT_DAILY_TOTAL_FACE_VALUE`（默认 5000）
4. `ADMIN_GIFTCARD_ISSUE_MAX_AMOUNT`（默认 500）
5. `ADMIN_GIFTCARD_ISSUE_DAILY_TOTAL_AMOUNT`（默认 5000）

## 建议下一阶段
1. 增加“二次验证（step-up）”用于发放操作确认
2. 增加“审批流（双人复核）”用于大额/批量发放
3. 后台页面增加阈值配置中心与风险命中提示
