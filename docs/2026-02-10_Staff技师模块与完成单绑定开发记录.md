# 开发更新：Staff（技师）模块与完成订单绑定（2026-02-10）

## 1. 需求目标
- 新增后台 Staff/Technician 管理能力：店铺可新增、编辑、删除技师。
- 同一店铺内技师名称不可重复；不同店铺可同名。
- 已完成（`completed`）订单支持绑定技师；默认不绑定（`technician_id = NULL`）。

## 2. 数据库与后端变更

### 2.1 表结构
- 新增迁移：`backend/alembic/versions/20260210_230000_add_hire_date_to_technicians.py`
- 变更：
  - `technicians` 新增字段：`hire_date`（`DATE`，可空）
  - 尝试创建唯一索引：`uq_technicians_store_name (store_id, name)`
    - 若检测到历史重复数据则跳过创建，避免迁移失败

### 2.2 技师接口规则
文件：`backend/app/api/v1/endpoints/technicians.py`
- 创建/更新技师时增加同店重名校验（名称 `trim + lower`）。
- 名称为空白直接拦截。
- 删除技师改为软删除（`is_active = 0`），保留历史订单关联。

### 2.3 订单绑定技师接口
文件：`backend/app/api/v1/endpoints/appointments.py`
- 新增接口：`PATCH /api/v1/appointments/{appointment_id}/technician`
- 请求体：`{ "technician_id": number | null }`
- 约束：
  - 仅超管/店铺管理员可操作
  - 店铺管理员只能操作本店订单
  - 仅 `completed` 状态订单可绑定技师
  - 技师必须属于同店铺且为在职
- 写入审计日志：`appointment.technician.update`

### 2.4 预约列表数据补充
文件：`backend/app/crud/appointment.py`
- 在预约详情查询中补充 `technician_name`，用于后台列表与详情展示。

## 3. 管理后台（admin-dashboard）变更

### 3.1 新增 Staff 页面
- 新文件：`admin-dashboard/src/pages/Staff.tsx`
- 功能：
  - 超管可选择店铺后管理技师
  - 店铺管理员管理自己店铺技师
  - 字段：名称、入职时间、手机号、邮箱
  - 支持新增、编辑、删除（软删除）

### 3.2 新增技师 API 封装
- 新文件：`admin-dashboard/src/api/technicians.ts`
- 包含：列表、创建、更新、删除、状态接口封装

### 3.3 Appointments 详情面板新增“绑定技师”
文件：`admin-dashboard/src/pages/AppointmentsList.tsx`
- 在右侧详情增加绑定下拉框与保存按钮
- 仅当订单状态为 `completed` 时可编辑
- 支持设置为 `Unassigned`

### 3.4 路由与入口
- 路由新增：`/admin/staff`
  - 文件：`admin-dashboard/src/App.tsx`
- More 页面新增入口：`Staff / Technicians`
  - 文件：`admin-dashboard/src/pages/More.tsx`

## 4. 校验结果
- 后端编译：`cd backend && ./venv/bin/python -m compileall app alembic` 通过
- 管理后台构建：`cd admin-dashboard && npm run build` 通过
- H5 构建：`cd frontend && npm run build` 通过

## 5. 说明
- 当前删除为软删除，满足历史订单可追溯。
- 若后续需要“离职技师列表”与“恢复在职”入口，可在 Staff 页面追加“显示离职 + 恢复”功能。
