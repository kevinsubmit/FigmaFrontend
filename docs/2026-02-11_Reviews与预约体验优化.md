# Reviews 与预约体验优化（2026-02-11）

## 一、后台 Reviews 模块落地

### 1. 后端新增后台评价列表接口
- 新增：`GET /api/v1/reviews/admin`
- 支持参数：
  - `skip` / `limit`（分页）
  - `store_id`（超管按店铺筛选）
  - `replied`（已回复/未回复）
  - `rating`（星级筛选）
  - `keyword`（用户名/评论/订单号搜索）

### 2. Review 数据一致性修复
- 修复评价创建/更新时图片字段未正确持久化问题。
- 新增图片数量校验：最多 5 张。
- 新增店铺评分汇总同步：评价新增/修改/删除后，自动刷新 `stores.rating` 与 `stores.review_count`。

### 3. Reply 权限增强
- 超级管理员可跨店创建/更新/删除回复。
- 店铺管理员保持仅可处理自己店铺评价。

### 4. 后台页面从占位页升级为可用页
- `admin-dashboard` 的 `Reviews` 页面已支持：
  - 评价列表查看
  - 筛选与分页
  - 回复/编辑回复/删除回复
  - 图片预览

---

## 二、H5 Reviews 头像与图片加载优化

### 1. 评论者头像策略
- 优先显示：用户头像（`user.avatar_url`）。
- 兜底策略：固定默认头像（按用户信息稳定生成）。
- 避免无头像时出现空白或断图。

### 2. 头像缓存刷新
- 后端返回 `user_avatar_updated_at`。
- 前端对头像 URL 附加版本参数，用户换头像后可及时刷新显示。

### 3. 资源 URL 统一解析
- 新增前端工具：统一处理相对路径/绝对路径/data URL。
- 去除 reviews 场景中 `localhost` 硬编码，适配本机/IP/生产环境。

---

## 三、后台 Appointments 体验优化

### 1. 客户电话字段统一
- 预约链路统一为单字段：`customer_phone`。
- 移除预约场景中的冗余 `user_phone`、`phone` 用法。

### 2. 电话交互
- 列表与详情支持点击电话发起拨号（`tel:`）。

### 3. 订单金额输入规则统一
- 前后端统一约束：订单金额最小值为 `1`。
- 输入步进改为 `1`。
- 输入与保存按整数处理（自动去小数与无效字符）。

### 4. 预约流程专业人员头像展示调整（H5）
- `SELECT PROFESSIONAL` 区域：所有专业人员头像改为与 `ANY` 相同图标样式。
- 预约摘要 `Professional` 行：移除名字后的头像，仅显示名称。

---

## 四、其它稳定性修复

### 1. React Router Future Warning
- 管理后台 `BrowserRouter` 增加 `future` 选项：
  - `v7_startTransition`
  - `v7_relativeSplatPath`
- 减少升级提示噪音。

### 2. Reviews 页店铺筛选 422 修复
- 前端店铺列表查询 `limit` 由 `200` 调整为 `100`，与后端参数约束一致。

---

## 五、影响范围
- 后端：reviews/review_replies/appointments/gift_cards 等接口与 schema。
- 后台：Reviews 页面、Appointments 页面、路由配置。
- H5：StoreReviews、ReviewForm、StoreDetails（预约流程）等页面。

