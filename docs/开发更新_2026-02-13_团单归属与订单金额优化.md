# 开发更新（2026-02-13）

## 一、团单能力完善（主单+子单）

### 1. 后端数据结构扩展
- `appointments` 新增字段：
  - `group_id`
  - `is_group_host`
  - `payment_status`
  - `paid_amount`
  - `booked_by_user_id`
  - `guest_name`
  - `guest_phone`
- 新增 `appointment_groups` 表用于管理团单主从关系。

### 2. 团单接口
- 新增：
  - `POST /api/v1/appointments/groups`
  - `POST /api/v1/appointments/groups/{group_id}/guests`
  - `GET /api/v1/appointments/groups/{group_id}`
- 支持同一时段创建主单+多个子单。

### 3. 团单状态联动
- 规则：只要团单任一子单 `completed`，主单自动 `completed`。
- 主单在 `completed` 时自动标记 `payment_status=paid` 与 `paid_amount`。

## 二、未注册客人归属（手机号挂账 + 注册自动认领）

### 1. 子单可绑定客人手机号
- 团单子单支持写入 `guest_phone`（可选 `guest_name`）。
- 若手机号已注册，子单直接归属到该用户。
- 若未注册，先按手机号挂账。

### 2. 注册自动认领
- 新用户注册成功后，系统自动认领其手机号对应的历史子单。
- 认领后订单号与已消费金额归属该用户本人。

### 3. 后台手动修正归属
- 新增接口：`PATCH /api/v1/appointments/{appointment_id}/guest-owner`
- 用于运营在后台修正团单子单手机号归属。

## 三、后台 Appointments 页面优化

### 1. 团单可视化
- 列表显示 `Group #ID · Host/Guest`。
- 右侧详情增加 Group Booking 卡片，展示组内主单和子单。

### 2. 金额修改入口优化
- 将金额修改入口上移到 `Service` 区块：
  - `Amount` 同行新增 `Edit Amount`
  - 展开后可直接保存
- 移除底部重复的 `Order Amount` 输入区，减少重复操作。

### 3. 金额修改后拆分区同步
- 保存金额后自动刷新 `Staff Amount Split` 摘要。
- 避免订单总额显示旧值。

### 4. 绑定技师与拆分状态放开
- `pending / confirmed / completed` 均可：
  - `Bind Staff`
  - `Staff Amount Split`
- 满足门店“先绑定/先拆分，最后 complete”的实际流程。

## 四、H5 预约流程优化

### 1. Group(Friends) 体验调整
- 去除 guest 姓名输入框，改为 `Guest 1/2/...` 固定标签。
- 删除按钮改为更明显的红色图标按钮。

### 2. 文案与提示
- 无可预约时间提示 `No available times for this date.` 改为红色。
- `Select Professional` / `Professional` 统一改为 `Technician`。

### 3. 团单下单与详情展示
- H5 支持单人/团单模式下单。
- 预约详情支持显示团单成员（Host/Guest）。

## 五、联调与验证
- 超管账号实测通过：
  - `pending` 订单可绑定技师。
  - 普通单可修改金额并持久化。
- 团单链路实测通过：
  - 创建团单
  - 查询团单
  - 未注册手机号注册后自动认领
  - 后台手动改归属后可即时生效

