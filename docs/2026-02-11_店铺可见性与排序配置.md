# 店铺可见性与排序配置（2026-02-11）

## 一、需求背景
为满足运营控制需求，后台新增两类能力：
1. 超级管理员可控制店铺是否在 H5 前台展示。
2. 超级管理员可配置推荐排序参数，用于节日活动、重点门店曝光等场景。

## 二、功能范围

### 1) 店铺可见性管理
- 页面：后台 `Stores` 列表页
- 权限：仅超级管理员可操作
- 行为：
  - `Show`：店铺在 H5 前台可见
  - `Hide`：店铺在 H5 前台隐藏
- 影响：
  - H5 普通用户查询店铺列表时，不会返回隐藏店铺
  - H5 普通用户访问隐藏店铺详情，返回 `404`
  - 后台管理员仍可管理该店铺
  - 预约创建时，如果店铺隐藏，将拒绝创建（返回 `Store is not available`）

### 2) 店铺推荐排序参数
- 页面：后台 `Stores` 列表页（每个店铺卡片）
- 权限：仅超级管理员可操作
- 参数：
  - `手动排序值(manual_rank)`：越小越靠前（建议从 `1` 开始）
  - `运营加权分(boost_score)`：可填正负值，正值提升曝光，负值降低曝光
  - `置顶截止时间(featured_until)`：在截止时间之前给予额外推荐加成
- 排序策略（`recommended`）：
  - 综合评分 = 质量分 + 距离分 + 手动排序分 + 运营加权分 + 置顶奖励
  - 最终按综合评分降序展示，并以手动排序值做稳定兜底

## 三、接口变更

### 1) 新增接口
- `PATCH /api/v1/stores/{store_id}/visibility`
  - 请求：`{ "is_visible": true|false }`
  - 权限：超级管理员
- `PATCH /api/v1/stores/{store_id}/ranking`
  - 请求示例：
    ```json
    {
      "manual_rank": 1,
      "boost_score": 0.2,
      "featured_until": "2026-12-25T23:59:00Z"
    }
    ```
  - 权限：超级管理员

### 2) 已有接口行为调整
- `GET /api/v1/stores`
- `GET /api/v1/stores/{store_id}`
- `GET /api/v1/stores/{store_id}/images`
- `GET /api/v1/stores/{store_id}/services`

上述接口默认对普通用户屏蔽隐藏店铺；管理员可查看。

## 四、数据库变更

### 1) 可见性字段
- 迁移：`backend/alembic/versions/20260210_030000_add_store_visibility.py`
- 新增字段：`stores.is_visible`（默认 `true`）

### 2) 排序字段
- 迁移：`backend/alembic/versions/20260210_040000_add_store_ranking_fields.py`
- 新增字段：
  - `stores.manual_rank`
  - `stores.boost_score`
  - `stores.featured_until`

## 五、前端页面变更
- 文件：`admin-dashboard/src/pages/StoresList.tsx`
- 主要内容：
  - 新增可见性开关按钮（Hide/Show）
  - 新增排序参数输入与保存按钮
  - 新增中文参数说明区，方便运营人员理解
- API 封装：`admin-dashboard/src/api/stores.ts`

## 六、验证结论
- 后端 OpenAPI 已包含：
  - `/api/v1/stores/{store_id}/visibility`
  - `/api/v1/stores/{store_id}/ranking`
- 后端编译通过
- 后台前端构建通过
- H5 前端构建通过

## 七、运营建议
1. `manual_rank` 建议按 1、2、3... 管理，不建议留过大空档。
2. `boost_score` 建议控制在 `-1.0` 到 `+1.0`。
3. 节日活动结束后应及时清理 `featured_until`，避免长期干预推荐结果。
