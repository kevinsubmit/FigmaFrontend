# 2026-02-22 iOS 登录态与预约体验收口

## 本次目标
- 收口 iOS 端会话失效处理：任何接口 401 后统一清理登录态并回到登录页。
- 完善预约链路体验：详情信息补全、过去时间拦截、Blocked Time 友好提示。
- 统一页面反馈风格：由零散红字/绿字提示统一为弹窗提示（Notice）。
- 修复 iOS 测试 target 配置，确保 `xcodebuild test` 可执行。

## 已完成内容

### 1) 全局 401 事件与统一登出
- 文件：`ios-app/NailsDashIOS/Sources/Core/Network/APIClient.swift`
  - 在 HTTP `401` 分支发送全局通知：`.apiUnauthorized`。
- 文件：`ios-app/NailsDashIOS/Sources/App/AppState.swift`
  - 监听 `.apiUnauthorized`，统一执行 `forceLogout(...)`。
  - 清理 access/refresh token，`isLoggedIn=false` 后自动回登录页。
  - 增加 `requireAccessToken()`，页面统一取 token，减少重复逻辑。
  - 提取统一文案常量：`sessionExpiredMessage`（`nonisolated static`）。

### 2) 预约详情页增强（My Appointments -> Detail）
- 文件：`ios-app/NailsDashIOS/Sources/Features/Appointments/MyAppointmentsView.swift`
- 新增展示字段：
  - Store
  - Address
  - Service
  - Amount
  - Duration
  - Technician
  - Created At
- 保留并可继续使用：Cancel / Reschedule 操作。

### 3) 预约创建页校验与提示增强（Book Appointment）
- 文件：`ios-app/NailsDashIOS/Sources/Features/Appointments/BookAppointmentViewModel.swift`
  - 提交前二次拦截过去时间：`Past time cannot be booked...`。
  - 新增 `slotHintMessage`：根据后端错误映射出更清晰的提示。
  - 对 blocked slot 给出专属提示：`This time slot is blocked by the store...`。
- 文件：`ios-app/NailsDashIOS/Sources/Features/Appointments/BookAppointmentView.swift`
  - 时间区域优先显示 `slotHintMessage`（红字）。

### 4) 反馈风格统一（Notice 弹窗）
- 文件：`ios-app/NailsDashIOS/Sources/Features/Appointments/BookAppointmentView.swift`
  - 移除顶部红/绿提示条，统一 `alert("Notice")`。
- 文件：`ios-app/NailsDashIOS/Sources/Features/Home/HomeView.swift`
  - `My Points` / `My Coupons` / `My Gift Cards` 三页统一为 `alert("Notice")`。
- 文件：`ios-app/NailsDashIOS/Sources/Features/Stores/StoresListView.swift`
  - 列表错误提示改为 `alert("Notice")`。
- 文件：`ios-app/NailsDashIOS/Sources/Features/Stores/StoreDetailView.swift`
  - 详情错误提示改为 `alert("Notice")`。
- 文件：`ios-app/NailsDashIOS/Sources/Features/Stores/StoresViewModel.swift`
  - 401 文案统一为 `AppState.sessionExpiredMessage`。

### 5) 测试 target 修复（让 xcodebuild test 可运行）
- 文件：`ios-app/project.yml`
  - 为 `NailsDashIOSTests` 增加：`GENERATE_INFOPLIST_FILE: YES`。
- 文件：`ios-app/NailsDashIOS.xcodeproj/project.pbxproj`
  - 在 `NailsDashIOSTests` 的 Debug/Release 构建配置中增加：
    - `GENERATE_INFOPLIST_FILE = YES;`

## 验证结果
- `xcodebuild build`：通过。
- `xcodebuild test`：通过（此前因 `NailsDashIOSTests` 缺少 Info.plist 导致失败，现已修复）。

## 手工回归建议（已可按此执行）
1. 登录成功后，模拟 token 失效，验证是否立即跳回登录页。
2. Book 页面选择过去时间，验证是否阻止提交并给出明确提示。
3. Book 页面选择 blocked slot，验证是否显示 blocked 专属提示。
4. My Appointments 详情页检查新增字段是否完整显示。
5. Stores / Profile 三页检查错误反馈是否统一为 Notice 弹窗。

## 备注
- 本次仅做 iOS 端体验和稳定性收口，不涉及后端接口协议变更。
