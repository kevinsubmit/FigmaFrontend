# 2026-02-20 店铺管理员权限回归与手机号脱敏统一

## 1. 目标
- 回归验证店铺管理员权限是否符合预期。
- 验证店铺管理员在 `include_full_phone=true` 场景下是否被严格拒绝。
- 前端统一手机号脱敏展示策略，减少明文暴露面。

## 2. 权限回归结论（店铺管理员）

### 2.1 正常可访问（200）
- `GET /api/v1/appointments/admin?...`
- `GET /api/v1/customers/admin?...`

### 2.2 无权限（403）
- `GET /api/v1/risk/users?...`
- `GET /api/v1/coupons/`
- `GET /api/v1/gift-cards/`

## 3. `include_full_phone=true` 严格校验结果

使用店铺管理员账号请求以下接口，均验证通过：

- `GET /api/v1/customers/admin?...&include_full_phone=true` -> `403`
  - `Only super admin can access full phone numbers`
- `GET /api/v1/appointments/admin?...&include_full_phone=true` -> `403`
  - `Only super admin can access full phone numbers`
- `GET /api/v1/risk/users?...&include_full_phone=true` -> `403`
  - 该接口本身对店铺管理员无权限（`Not enough permissions`）

## 4. 代码变更

### 4.1 后端
- `backend/app/api/v1/endpoints/appointments.py`
  - 补充店铺管理员对 `include_full_phone=true` 的显式 403 拒绝逻辑。

### 4.2 管理后台（Admin）
- 新增统一脱敏工具：
  - `admin-dashboard/src/utils/privacy.ts`
- 脱敏接入页面：
  - `admin-dashboard/src/pages/AppointmentDetail.tsx`
  - `admin-dashboard/src/pages/AppointmentsList.tsx`
  - `admin-dashboard/src/pages/Applications.tsx`
  - `admin-dashboard/src/pages/StoreApplication.tsx`
  - `admin-dashboard/src/pages/Logs.tsx`
  - `admin-dashboard/src/pages/Customers.tsx`
  - `admin-dashboard/src/pages/RiskControl.tsx`
  - `admin-dashboard/src/pages/Coupons.tsx`
  - `admin-dashboard/src/pages/GiftCards.tsx`
- 接口参数保护：
  - `admin-dashboard/src/api/appointments.ts`
  - 非超管默认不请求 `include_full_phone=true`。

### 4.3 H5 前端
- 新增统一脱敏工具：
  - `frontend/src/utils/privacy.ts`
- 脱敏接入页面：
  - `frontend/src/components/ReferralPage.tsx`
  - `frontend/src/components/MyGiftCards.tsx`

## 5. 验证记录
- `admin-dashboard` 构建通过：`npm run build`
- 安全与权限接口本地实测通过（见第 2/3 节）

## 6. 备注
- 本次提交不包含本地运行产物（如 `__pycache__`、`.env`、本地数据库文件）。
