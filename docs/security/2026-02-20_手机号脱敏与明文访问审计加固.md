# 2026-02-20 手机号脱敏与明文访问审计加固

## 背景

为降低平台用户手机号被批量爬取、误暴露或越权读取风险，对后台高频接口进行了“默认脱敏 + 明文显式开关 + 审计日志”改造。

## 本次改动范围

### 1) 通用隐私工具

新增文件：
- `/Users/fengliangli/code/FigmaFrontend/backend/app/utils/phone_privacy.py`

提供能力：
- `mask_phone(phone)`：统一手机号脱敏（如 `+1******1234`）
- `validate_keyword_min_length(keyword, min_length=3)`：关键词最短长度校验，降低枚举扫描风险

### 2) Customers 接口

文件：
- `/Users/fengliangli/code/FigmaFrontend/backend/app/api/v1/endpoints/customers.py`

改动：
- `GET /api/v1/customers/admin`
  - 默认返回脱敏手机号
  - 支持 `include_full_phone=true` 返回明文（仅超管可用）
  - 明文查询写审计日志：`customers.list.full_phone`
- `GET /api/v1/customers/admin/{customer_id}`
  - 默认返回脱敏手机号
  - 支持 `include_full_phone=true` 返回明文（仅超管可用）
  - 明文查询写审计日志：`customers.detail.full_phone`
- 关键词查询增加最小长度限制（3）

### 3) Risk 接口

文件：
- `/Users/fengliangli/code/FigmaFrontend/backend/app/api/v1/endpoints/risk.py`

改动：
- `GET /api/v1/risk/users`
  - 默认返回脱敏手机号
  - 支持 `include_full_phone=true` 返回明文（仅超管可用）
  - 明文查询写审计日志：`risk.users.full_phone`
- 风控用户操作返回中的手机号改为脱敏
- 关键词查询增加最小长度限制（3）

### 4) Appointments 管理接口

文件：
- `/Users/fengliangli/code/FigmaFrontend/backend/app/api/v1/endpoints/appointments.py`
- `/Users/fengliangli/code/FigmaFrontend/admin-dashboard/src/api/appointments.ts`

改动：
- `GET /api/v1/appointments/admin`
  - 默认返回脱敏手机号
  - 支持 `include_full_phone=true` 返回明文
  - 明文查询写审计日志：`appointments.admin.full_phone`
- 管理后台请求该接口时自动携带 `include_full_phone=true`，保证运营页面体验不受影响

### 5) H5 PhoneManagement 401 修复

文件：
- `/Users/fengliangli/code/FigmaFrontend/frontend/src/components/PhoneManagement.tsx`

改动：
- token 读取统一 `access_token || token`
- 401 时清理登录态并跳转登录页

## 已验证

### 接口验证（超管账号）

- `customers/admin`
  - 默认：脱敏
  - `include_full_phone=true`：明文
- `risk/users`
  - 默认：脱敏
  - `include_full_phone=true`：明文
- `appointments/admin`
  - 默认：脱敏
  - `include_full_phone=true`：明文

### 编译验证

- 后端：`python -m compileall app`
- H5 前端：`npm run build`
- Admin 前端：`npm run build`

## 后续建议

1. 增加“店铺管理员请求 `include_full_phone=true` 必须 403”的自动化回归测试。  
2. 将明文手机号访问频次加入 Dashboard 安全监控面板。  
3. 对导出类接口统一增加手机号字段级审批和审计。
