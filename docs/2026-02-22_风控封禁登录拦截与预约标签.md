# 2026-02-22 风控封禁、登录拦截与预约标签展示

## 1. 风控能力增强（仅超管）

### 新增动作
- `ban_permanent`：永久封禁账号（`is_active=false`）
- `unban_permanent`：解除永久封禁（`is_active=true`）

### 风控列表新增字段
- `is_active`
- `account_status`（`active` / `permanently_banned`）

### 管理后台 Risk 页面
- 新增按钮：`Permanent Ban` / `Remove Ban`
- 增加账号状态展示：`Active` / `Permanently Banned`
- 永久封禁时禁用 24h 临时限制按钮

## 2. H5 登录态拦截（受限自动退出）

### 后端拦截
- 在 `get_current_user` 依赖层对普通前台用户增加临时限制校验：
  - 若 `restricted_until > now`，统一返回 `403`
- 在 `POST /auth/login` 登录流程增加同样校验：
  - 受限期间无法登录，返回 `403`

### 前端处理
- H5 Axios/API 客户端新增统一拦截：
  - 当响应为 `403` 且命中“账号受限/封禁”文案时
  - 立即清理 token 并跳转 `/login`

## 3. Appointments 增加客户标签展示

### 后端
- `appointments/admin` 返回新增字段：`customer_tags: string[]`
- 标签解析规则：
  - 去空、大小写去重
  - 单个标签最多 24 字符
  - 最多 8 个

### 管理后台
- Appointments Timeline 卡片与右侧列表客户名后展示标签胶囊

## 4. Customers 标签管理（本次一并整理）

### 数据库
- `backend_users.customer_tags`（Text，JSON 数组）

### 接口
- `PUT /api/v1/customers/admin/{customer_id}/tags`
- 支持多标签保存并回显

### 管理后台
- Customers 列表展示标签
- Customer Detail 支持编辑标签并保存

## 5. 涉及文件

### Backend
- `backend/app/api/deps.py`
- `backend/app/api/v1/endpoints/auth.py`
- `backend/app/api/v1/endpoints/risk.py`
- `backend/app/api/v1/endpoints/appointments.py`
- `backend/app/schemas/appointment.py`
- `backend/app/api/v1/endpoints/customers.py`
- `backend/app/models/user.py`
- `backend/alembic/versions/20260220_120000_add_customer_tags_to_users.py`

### Admin
- `admin-dashboard/src/api/appointments.ts`
- `admin-dashboard/src/pages/AppointmentsList.tsx`
- `admin-dashboard/src/api/risk.ts`
- `admin-dashboard/src/pages/RiskControl.tsx`
- `admin-dashboard/src/api/customers.ts`
- `admin-dashboard/src/pages/Customers.tsx`

### H5
- `frontend/src/api/client.ts`
- `frontend/src/lib/api.ts`
- `frontend/src/utils/authGuard.ts`
