# 开发更新：订单支持多技师金额拆分（2026-02-11）

## 1. 目标
后台预约订单支持金额拆分：
- 一个订单可拆分给 2 个或以上技师。
- 每条拆分可填写工作项目（如 hand / foot）和金额。
- 拆分金额总和必须等于订单总金额。

## 2. 后端实现

### 2.1 新增数据表
- `appointment_staff_splits`
  - `id`
  - `appointment_id`
  - `technician_id`
  - `work_type`（可选）
  - `amount`
  - `created_at`
  - `updated_at`

迁移文件：
- `backend/alembic/versions/20260211_000000_add_appointment_staff_splits.py`

模型文件：
- `backend/app/models/appointment_staff_split.py`

### 2.2 新增接口
- `GET /api/v1/appointments/{appointment_id}/splits`
  - 返回订单金额、拆分总和、是否平衡、拆分明细。

- `PUT /api/v1/appointments/{appointment_id}/splits`
  - 请求体：`splits[]`（`technician_id`、`work_type`、`amount`）
  - 约束：
    - 仅超管 / 店铺管理员可操作
    - 店铺管理员仅可操作自己店铺订单
    - 仅 `completed` 订单允许保存拆分
    - 拆分技师必须属于同店铺
    - 拆分金额总和必须等于订单金额

实现文件：
- `backend/app/api/v1/endpoints/appointments.py`
- `backend/app/schemas/appointment.py`

### 2.3 审计日志
保存拆分时会记录审计日志：
- action: `appointment.staff_splits.update`
- before/after：拆分明细快照

## 3. 管理后台实现

### 3.1 预约详情右侧新增“Staff Amount Split”
页面：`admin-dashboard/src/pages/AppointmentsList.tsx`
- 支持多行编辑：技师 + 工作项目 + 金额
- 支持新增/删除拆分行
- 实时显示：订单总金额、当前拆分总和
- 显示平衡状态（Balanced / Not Balanced）
- 仅 completed 订单可保存

### 3.2 API 封装
文件：`admin-dashboard/src/api/appointments.ts`
- `getAppointmentStaffSplits`
- `updateAppointmentStaffSplits`

## 4. 编译验证
- 后端编译通过：`cd backend && ./venv/bin/python -m compileall app alembic`
- 管理后台构建通过：`cd admin-dashboard && npm run build`
