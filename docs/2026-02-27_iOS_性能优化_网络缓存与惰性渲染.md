# iOS 性能优化记录（2026-02-27）

## 一、目标
对 iOS 端进行一轮基础性能优化，重点覆盖：

- 内存：减少重复 URL 构造对象与重复解码带来的内存抖动。
- CPU：减少重复字符串拼接、重复列表渲染。
- 网络层会话：为高频 GET 请求增加短时内存缓存，减少短时间重复请求。
- 资源 URL 基址处理：统一并缓存资源 URL 解析逻辑。
- 列表惰性渲染：将部分非惰性列表改为惰性渲染，降低首屏和滚动开销。

## 二、代码变更

### 1) 网络层：GET 响应内存缓存（短 TTL）
文件：`ios-app/NailsDashIOS/Sources/Core/Network/APIClient.swift`

新增能力：

- 仅针对 `GET` 请求做内存缓存命中。
- 缓存 key 包含 URL + Authorization + Accept-Language（避免不同用户会话串数据）。
- 缓存 TTL：8 秒（短时去重，避免 stale 风险过高）。
- 缓存上限：120 条，超限按最早写入淘汰。
- `POST/PUT/PATCH/DELETE` 成功后清空缓存，保证写后读一致性。

实现点：

- `ResponseMemoryCache`（线程安全，`NSLock` 保护）。
- `cacheKey(for:)` 生成逻辑。
- `request(...)` 中 GET 读缓存、请求成功后写缓存、变更请求清缓存。

### 2) 资源 URL 解析统一 + 缓存
文件：`ios-app/NailsDashIOS/Sources/Core/Network/APIClient.swift`

新增 `AssetURLResolver`：

- 支持绝对 URL 直接返回。
- 相对路径自动按 `assetBaseURL` 拼接。
- 使用 `NSCache<NSString, NSURL>` 缓存解析结果。
- 提供：
  - `resolveURL(from:)`
  - `resolveString(from:)`

### 3) 页面侧 URL 解析去重
替换为统一解析器，减少重复逻辑与重复构造：

- `ios-app/NailsDashIOS/Sources/Features/Home/HomeView.swift`
- `ios-app/NailsDashIOS/Sources/Features/Stores/StoresListView.swift`
- `ios-app/NailsDashIOS/Sources/Features/Stores/StoreDetailView.swift`
- `ios-app/NailsDashIOS/Sources/Features/Appointments/BookAppointmentView.swift`

### 4) 列表惰性渲染优化
文件：`ios-app/NailsDashIOS/Sources/Features/Home/HomeView.swift`

- Deals 列表：`VStack` -> `LazyVStack`
- My Reviews 列表：`VStack` -> `LazyVStack`

效果：

- 降低大列表初次构建成本。
- 减少滚动阶段一次性布局和绘制开销。

## 三、验证结果

### 编译验证
已执行：

```bash
xcodebuild -project ios-app/NailsDashIOS.xcodeproj \
  -scheme NailsDashIOS \
  -configuration Debug \
  -destination 'generic/platform=iOS Simulator' \
  CODE_SIGNING_ALLOWED=NO build
```

结果：`BUILD SUCCEEDED`

## 四、兼容性与风险说明

- 本次未改 API 协议字段、路由、业务数据结构。
- GET 缓存为短 TTL + 写后清缓存，优先控制一致性风险。
- URL 解析统一后，减少多处实现不一致导致的边界问题。

## 五、后续建议（下一轮可选）

- 图片解码降采样（按显示尺寸下采样，降低内存峰值）。
- 列表预取与分页策略统一（减少高峰并发请求）。
- 关键页面加 Instruments 基线对比（CPU、内存、网络请求数）。
