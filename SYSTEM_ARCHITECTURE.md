# 系统架构文档

## 概述

美甲预约平台是一个完整的O2O服务预约系统，采用前后端分离架构，支持用户预约、店铺管理、积分优惠券、通知提醒、推荐好友等功能。本文档详细说明系统的技术架构、模块设计和部署方案。

## 技术栈

### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.9+ | 编程语言 |
| FastAPI | 0.104+ | Web框架 |
| SQLAlchemy | 2.0+ | ORM框架 |
| MySQL | 8.0+ | 关系型数据库 |
| Alembic | 1.12+ | 数据库迁移 |
| Pydantic | 2.0+ | 数据验证 |
| JWT | - | 认证令牌 |
| APScheduler | 3.10+ | 定时任务 |
| Uvicorn | 0.24+ | ASGI服务器 |

### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18+ | UI框架 |
| TypeScript | 5.0+ | 编程语言 |
| Ionic | 7+ | 移动端UI组件 |
| React Router | 6+ | 路由管理 |
| Axios | 1.6+ | HTTP客户端 |
| Tailwind CSS | 3+ | CSS框架 |

### 开发工具

| 工具 | 用途 |
|------|------|
| Git | 版本控制 |
| Pytest | 后端测试 |
| Jest | 前端测试 |
| Postman | API测试 |
| VS Code | 代码编辑器 |

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                      客户端层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  Web浏览器   │  │  iOS应用     │  │  Android应用  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          │ HTTPS
                          ▼
┌─────────────────────────────────────────────────────────┐
│                      API网关层                            │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Nginx / API Gateway                              │  │
│  │  - 负载均衡  - SSL终止  - 速率限制  - 日志记录    │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          │ HTTP
                          ▼
┌─────────────────────────────────────────────────────────┐
│                      应用层                               │
│  ┌──────────────────────────────────────────────────┐  │
│  │  FastAPI应用服务器 (Uvicorn)                      │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐ │  │
│  │  │ 认证模块   │  │ 预约模块   │  │ 积分模块   │ │  │
│  │  └────────────┘  └────────────┘  └────────────┘ │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐ │  │
│  │  │ 通知模块   │  │ 推荐模块   │  │ 店铺模块   │ │  │
│  │  └────────────┘  └────────────┘  └────────────┘ │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          │ SQL
                          ▼
┌─────────────────────────────────────────────────────────┐
│                      数据层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  MySQL主库   │  │  MySQL从库   │  │  Redis缓存   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                      外部服务                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  短信服务    │  │  对象存储    │  │  支付网关    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 模块架构

#### 后端模块结构

```
backend/
├── app/
│   ├── api/                    # API端点
│   │   └── v1/
│   │       └── endpoints/      # 各模块端点
│   │           ├── auth.py     # 认证
│   │           ├── users.py    # 用户
│   │           ├── stores.py   # 店铺
│   │           ├── appointments.py  # 预约
│   │           ├── points.py   # 积分
│   │           ├── coupons.py  # 优惠券
│   │           ├── notifications.py  # 通知
│   │           └── referrals.py     # 推荐
│   ├── models/                 # 数据模型
│   │   ├── user.py
│   │   ├── store.py
│   │   ├── appointment.py
│   │   ├── coupon.py
│   │   └── ...
│   ├── schemas/                # 数据验证
│   │   ├── user.py
│   │   ├── store.py
│   │   └── ...
│   ├── crud/                   # 数据库操作
│   │   ├── user.py
│   │   ├── store.py
│   │   └── ...
│   ├── services/               # 业务逻辑
│   │   ├── notification_service.py
│   │   ├── scheduler.py
│   │   └── ...
│   ├── core/                   # 核心配置
│   │   ├── config.py
│   │   ├── security.py
│   │   └── database.py
│   └── utils/                  # 工具函数
├── alembic/                    # 数据库迁移
├── tests/                      # 测试文件
└── main.py                     # 应用入口
```

#### 前端模块结构

```
frontend/
├── src/
│   ├── components/             # React组件
│   │   ├── Profile.tsx         # 个人中心
│   │   ├── StoreList.tsx       # 店铺列表
│   │   ├── StoreDetail.tsx     # 店铺详情
│   │   ├── Appointment.tsx     # 预约页面
│   │   ├── MyPoints.tsx        # 我的积分
│   │   ├── MyCoupons.tsx       # 我的优惠券
│   │   ├── Notifications.tsx   # 通知中心
│   │   └── ReferralPage.tsx    # 推荐页面
│   ├── services/               # API服务
│   │   ├── auth.service.ts
│   │   ├── store.service.ts
│   │   ├── appointment.service.ts
│   │   ├── points.service.ts
│   │   ├── coupons.service.ts
│   │   ├── notifications.service.ts
│   │   └── referrals.service.ts
│   ├── types/                  # TypeScript类型
│   ├── utils/                  # 工具函数
│   ├── App.tsx                 # 应用入口
│   └── index.tsx               # 渲染入口
├── public/                     # 静态资源
└── package.json                # 依赖配置
```

## 核心模块设计

### 1. 认证模块

**功能**：
- 用户注册（手机号+验证码）
- 用户登录（手机号+密码）
- JWT Token生成和验证
- 推荐码处理

**流程图**：
```
用户注册流程:
1. 用户输入手机号 → 发送验证码
2. 用户输入验证码+密码+推荐码 → 验证
3. 创建用户记录 → 生成推荐码
4. 处理推荐关系 → 发放推荐奖励
5. 返回用户信息

用户登录流程:
1. 用户输入手机号+密码
2. 验证凭据
3. 生成JWT Token
4. 返回Token和用户信息
```

### 2. 预约模块

**功能**：
- 创建预约
- 查看预约列表
- 更新预约状态
- 取消预约
- 预约提醒

**状态流转**：
```
pending (待确认)
    ↓
confirmed (已确认)
    ↓
completed (已完成) → 发放积分
    ↓
cancelled (已取消)
```

### 3. 积分和优惠券模块

**功能**：
- 积分获取（订单完成）
- 积分兑换优惠券
- 优惠券领取
- 优惠券使用
- 优惠券过期检查

**业务规则**：
- 1美金 = 1积分
- 100积分 = $5优惠券
- 优惠券有效期可配置
- 一个订单只能使用一张优惠券

### 4. 通知模块

**功能**：
- 预约状态变更通知
- 预约前提醒（24小时/1小时）
- 通知列表查看
- 标记已读/删除

**通知类型**：
- 预约创建
- 预约确认
- 预约取消
- 预约完成
- 预约提醒
- 系统通知

### 5. 推荐模块

**功能**：
- 推荐码生成
- 推荐关系记录
- 推荐奖励发放
- 推荐统计
- 推荐列表

**奖励规则**：
- 注册成功时双方各得$10优惠券
- 推荐码6位字母数字混合
- 推荐关系永久记录

## 数据库设计

### 核心表结构

#### 用户相关

- **backend_users**: 用户基本信息
- **user_points**: 用户积分
- **point_transactions**: 积分明细
- **referrals**: 推荐关系

#### 店铺相关

- **stores**: 店铺信息
- **services**: 服务项目
- **technicians**: 技师信息
- **store_hours**: 营业时间
- **store_holidays**: 节假日
- **store_portfolio**: 作品集

#### 预约相关

- **appointments**: 预约记录
- **reviews**: 评价
- **review_replies**: 评价回复

#### 营销相关

- **coupons**: 优惠券模板
- **user_coupons**: 用户优惠券
- **notifications**: 通知记录

### 数据库关系图

```
backend_users (用户)
    ├─→ user_points (积分)
    │       └─→ point_transactions (积分明细)
    ├─→ user_coupons (用户优惠券)
    │       └─→ coupons (优惠券模板)
    ├─→ appointments (预约)
    │       ├─→ stores (店铺)
    │       ├─→ services (服务)
    │       └─→ technicians (技师)
    ├─→ reviews (评价)
    ├─→ notifications (通知)
    └─→ referrals (推荐关系)
```

## API设计原则

### RESTful设计

- 使用HTTP方法表示操作（GET/POST/PUT/DELETE）
- 使用名词表示资源（/users, /stores）
- 使用复数形式（/users而非/user）
- 使用子资源表示关系（/stores/{id}/services）

### 响应格式

**成功响应**：
```json
{
  "data": {...},
  "message": "Success"
}
```

**错误响应**：
```json
{
  "detail": "Error message"
}
```

### 状态码使用

- 200: 成功
- 201: 创建成功
- 204: 删除成功（无内容）
- 400: 请求错误
- 401: 未认证
- 403: 无权限
- 404: 资源不存在
- 500: 服务器错误

## 安全设计

### 认证和授权

1. **JWT Token认证**
   - Token有效期24小时
   - 包含用户ID和角色信息
   - 使用HS256算法签名

2. **权限控制**
   - 用户只能访问自己的数据
   - 管理员可以访问所有数据
   - 店铺管理员只能管理自己的店铺

### 数据安全

1. **密码加密**
   - 使用bcrypt加密存储
   - 加盐处理，防止彩虹表攻击

2. **敏感信息保护**
   - 手机号脱敏显示
   - 不返回密码字段
   - 日志中不记录敏感信息

### 接口安全

1. **速率限制**
   - 认证接口：10次/分钟
   - 读取接口：100次/分钟
   - 写入接口：30次/分钟

2. **输入验证**
   - 使用Pydantic验证所有输入
   - 防止SQL注入
   - 防止XSS攻击

## 性能优化

### 数据库优化

1. **索引设计**
   - 主键索引
   - 外键索引
   - 查询字段索引（user_id, status, created_at）

2. **查询优化**
   - 使用分页避免大量数据加载
   - 使用JOIN减少查询次数
   - 避免N+1查询问题

### 缓存策略

1. **Redis缓存**
   - 用户信息缓存（1小时）
   - 店铺信息缓存（30分钟）
   - 热点数据缓存

2. **前端缓存**
   - 静态资源缓存
   - API响应缓存
   - LocalStorage存储

### 并发处理

1. **数据库连接池**
   - 最小连接数：5
   - 最大连接数：20
   - 连接超时：30秒

2. **异步处理**
   - 使用async/await
   - 定时任务异步执行
   - 通知异步发送

## 部署架构

### 开发环境

```
本地开发:
- 后端: http://localhost:8000
- 前端: http://localhost:3000
- 数据库: localhost:3306
```

### 生产环境

```
生产部署:
- API服务器: https://api.yourdomain.com
- Web服务器: https://www.yourdomain.com
- 数据库: 主从复制
- 缓存: Redis集群
- 负载均衡: Nginx
```

### 部署流程

1. **代码部署**
   ```bash
   git pull origin main
   pip install -r requirements.txt
   alembic upgrade head
   systemctl restart backend
   ```

2. **数据库迁移**
   ```bash
   alembic revision --autogenerate -m "description"
   alembic upgrade head
   ```

3. **前端部署**
   ```bash
   npm install
   npm run build
   nginx -s reload
   ```

## 监控和日志

### 日志系统

1. **应用日志**
   - 请求日志（访问时间、IP、路径）
   - 错误日志（异常堆栈、上下文）
   - 业务日志（关键操作记录）

2. **日志级别**
   - DEBUG: 调试信息
   - INFO: 一般信息
   - WARNING: 警告信息
   - ERROR: 错误信息
   - CRITICAL: 严重错误

### 监控指标

1. **系统监控**
   - CPU使用率
   - 内存使用率
   - 磁盘使用率
   - 网络流量

2. **应用监控**
   - API响应时间
   - 请求成功率
   - 错误率
   - 并发连接数

3. **业务监控**
   - 用户注册数
   - 预约创建数
   - 积分发放数
   - 优惠券使用率

## 测试策略

### 单元测试

- 覆盖率目标：80%+
- 测试框架：Pytest
- 测试内容：
  - 数据模型
  - CRUD操作
  - 业务逻辑
  - 工具函数

### 集成测试

- 测试API端点
- 测试数据库操作
- 测试外部服务集成

### 端到端测试

- 测试完整业务流程
- 测试用户交互
- 测试前后端集成

## 扩展性设计

### 水平扩展

1. **应用层扩展**
   - 无状态设计
   - 支持多实例部署
   - 负载均衡

2. **数据层扩展**
   - 主从复制
   - 读写分离
   - 分库分表

### 功能扩展

1. **模块化设计**
   - 松耦合
   - 高内聚
   - 易于添加新功能

2. **插件化架构**
   - 支付网关插件
   - 短信服务插件
   - 推送服务插件

## 未来规划

### 短期目标（3个月）

- [ ] 完善管理后台
- [ ] 添加支付功能
- [ ] 优化性能
- [ ] 增加单元测试覆盖率

### 中期目标（6个月）

- [ ] 添加会员系统
- [ ] 添加营销活动管理
- [ ] 实现实时通知（WebSocket）
- [ ] 添加数据分析仪表板

### 长期目标（12个月）

- [ ] 支持多语言
- [ ] 支持多货币
- [ ] 开放API平台
- [ ] 小程序版本

## 相关文档

- [API接口文档](./API_DOCUMENTATION.md)
- [通知系统文档](./NOTIFICATION_SYSTEM.md)
- [积分和优惠券系统文档](./POINTS_COUPONS_SYSTEM.md)
- [推荐好友系统文档](./REFERRAL_SYSTEM.md)

---

**文档版本**: 1.0  
**最后更新**: 2026-01-05  
**维护者**: Manus AI
